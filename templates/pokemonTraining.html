{% extends 'base.html' %}

{% block content %}
    <ul class="container">
        {% for _id in default %}
        <li class="{{ _id }} pokemon">
            <p class="pokeLevel">LEVEL {{ default[_id]['level']}}</p>
            <img src="../static/images/{{ default[_id]['id'] }}.png" />
            <p>{{ pokemons[default[_id]['id']]['name'] }}</p>
            <p>{{ (default[_id]['percent']|float * default[_id]['max'])|round|int }} ({{ (default[_id]['percent']|float * 100)|round|int }}%)</p>
            <input type="button" class="trainingBtn" value="선택">
        </li>

        {% endfor %}
    </ul>
    <script>
        const pokemonJSON = JSON.parse('{{default|tojson}}');
        const trainingBtn = [...getClass('trainingBtn')]

        function setBackgroundColor() {
            Object.keys(pokemonJSON).forEach(pokemons => {
                    const percent = pokemonJSON[pokemons]['percent'] * 100
                    const pokemon = getClass(pokemons)[0];
                    if (percent === 100) {
                        pokemon.style.background = 'black'
                        pokemon.style.color = 'rgb(177 161 78)'
                    } else if (percent >= 90) {
                        pokemon.style.background = 'red'
                    } else if (percent >= 50) {
                        pokemon.style.background = 'green'
                    } else if (percent >= 30) {
                        pokemon.style.background = 'blue'
                    }  else {
                        pokemon.style.background = 'yellow'
                    }
            })
        }
        setBackgroundColor();

        trainingBtn.forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const pokemonID = e.target.parentElement.classList[0];
                console.log(pokemonID)
                const option = new URLSearchParams({
                    field: 'training',
                    pokemonID: pokemonID
                });
                
                const post = await myPokemonPost(option)
                const data = await post.json();

                if (!data.msg) {
                    alert('percent가 ' + data*100 + '(이)가 되었다!')
                    pokemonJSON[pokemonID]['percent'] = data;
                    getClass(pokemonID)[0].children[3].innerText = parseFloat(Math.round(pokemonJSON[pokemonID]['percent'] * pokemonJSON[pokemonID]['max'])) + " (" + parseInt(Math.round(parseFloat(pokemonJSON[pokemonID]['percent']) * 100)) + "%)";
                    setBackgroundColor()
                } else {
                    alert(data.msg)
                }
            })
        })

        async function myPokemonPost(option) {
            return fetch('/myPokemon', {
                method: 'POST',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: option
            })
        }
    </script>
{% endblock %}